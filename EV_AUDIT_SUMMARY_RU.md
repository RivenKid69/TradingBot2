# –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï: –ê–£–î–ò–¢ –í–´–ß–ò–°–õ–ï–ù–ò–ô EV

**–î–∞—Ç–∞:** 2025-11-09

## üéØ –û–°–ù–û–í–ù–û–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü—Ä–æ–≤–µ–¥–µ–Ω –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –≤—Å–µ—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è (Expected Value, EV) –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –Ω–∏–º–∏ –º–µ—Ç—Ä–∏–∫.

**–û–±—â–∏–π –≤–µ—Ä–¥–∏–∫—Ç:** ‚úÖ **–ö–æ–¥–æ–≤–∞—è –±–∞–∑–∞ –≤ —Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏**

---

## ‚úÖ –ö–û–†–†–ï–ö–¢–ù–´–ï –í–´–ß–ò–°–õ–ï–ù–ò–Ø

### 1. EV –∏–∑ –∫–≤–∞–Ω—Ç–∏–ª–µ–π
- **–§–∞–π–ª—ã:** `distributional_ppo.py:1975, 8191, 8276, 8370`
- **–ö–æ–¥:** `quantiles.mean(dim=1)`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ö–≤–∞–Ω—Ç–∏–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–∞–∫ midpoints —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –¥–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞

### 2. EV –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- **–§–∞–π–ª—ã:** `distributional_ppo.py:6085, 6288`
- **–ö–æ–¥:** `(probs * atoms).sum()`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ EV = Œ£ p·µ¢ * v·µ¢

### 3. Explained Variance
- **–§–∞–π–ª—ã:** `distributional_ppo.py:192-273, 341-455`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Å Bessel's correction, –µ—Å—Ç—å safeguards –ø—Ä–æ—Ç–∏–≤ overflow

### 4. Empirical CVaR
- **–§–∞–π–ª:** `distributional_ppo.py:2619-2654`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π estimator - —Å—Ä–µ–¥–Ω–µ–µ —Ö—É–¥—à–∏—Ö Œ±% –Ω–∞–±–ª—é–¥–µ–Ω–∏–π

### 5. CVaR –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- **–§–∞–π–ª:** `distributional_ppo.py:458-501`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ï—Å—Ç—å unit test —Å —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π (test_distributional_ppo_cvar.py:92)

---

## ‚ö†Ô∏è –ù–ê–ô–î–ï–ù–ê –ü–†–û–ë–õ–ï–ú–ê

### CVaR –∏–∑ –∫–≤–∞–Ω—Ç–∏–ª–µ–π - —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°–†–ï–î–ù–ò–ô
**–§–∞–π–ª:** `distributional_ppo.py:2476-2500` (—Ñ—É–Ω–∫—Ü–∏—è `_cvar_from_quantiles`)
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:** –¢–æ–ª—å–∫–æ –ø—Ä–∏ –∫–≤–∞–Ω—Ç–∏–ª—å–Ω–æ–º –∫—Ä–∏—Ç–∏–∫–µ (`_use_quantile_value=True`)

#### –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

–§—É–Ω–∫—Ü–∏—è `_cvar_from_quantiles` –≤—ã—á–∏—Å–ª—è–µ—Ç CVaR (Conditional Value at Risk) –∏–∑ –∫–≤–∞–Ω—Ç–∏–ª–µ–π, –Ω–æ **–Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç**, —á—Ç–æ –∫–≤–∞–Ω—Ç–∏–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π **—Ü–µ–Ω—Ç—Ä—ã** (midpoints) –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤, –∞ –Ω–µ –≥—Ä–∞–Ω–∏—Ü—ã.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
- `cvar_alpha = 0.05` (5% —Ö—É–¥—à–∏—Ö –∏—Å—Ö–æ–¥–æ–≤)
- `num_quantiles = 32`

#### –ß–∏—Å–ª–µ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä

–î–ª—è **N=5 –∫–≤–∞–Ω—Ç–∏–ª–µ–π** –∏ Œ±=0.05 (—Ö—É–¥—à–∏–π —Å–ª—É—á–∞–π):

```python
# –ö–≤–∞–Ω—Ç–∏–ª–∏: [Q(0.1), Q(0.3), Q(0.5), Q(0.7), Q(0.9)]
# –î–ª—è Œ±=0.05 —Ñ—É–Ω–∫—Ü–∏—è –±–µ—Ä–µ—Ç Q(0.1)
# –ù–æ Q(0.1) –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª [0.0, 0.2], –∞ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ [0.0, 0.05]

# –î–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö –∫–≤–∞–Ω—Ç–∏–ª–µ–π Q(œÑ) = -2 + 4œÑ:
–∏—Å—Ç–∏–Ω–Ω—ã–π_CVaR = -1.90
–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π_CVaR = -1.60
–æ—à–∏–±–∫–∞ = 15.8%  # –°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ!
```

–î–ª—è **N=32 –∫–≤–∞–Ω—Ç–∏–ª–µ–π** (—Ä–µ–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã):
- –û—à–∏–±–∫–∞: **~3-5%**
- –°–º–µ—â–µ–Ω–∏–µ: CVaR **–º–µ–Ω–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–µ–Ω** (–±–ª–∏–∂–µ –∫ –Ω—É–ª—é)

#### –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª—é

1. **–ù–µ–¥–æ–æ—Ü–µ–Ω–∫–∞ downside —Ä–∏—Å–∫–∞** –Ω–∞ 3-5%
2. **–ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞**, —á–µ–º –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–ª–æ—Å—å
3. **Risk penalty –≤ loss —Ñ—É–Ω–∫—Ü–∏–∏** —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∞–±–µ–µ

#### –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ –∫–æ–¥–µ

–í –∫–æ–¥–µ –µ—Å—Ç—å TODO (—Å—Ç—Ä–æ–∫–∞ 2484):
```python
# TODO(quantile-critic): When migrating to non-uniform quantile levels
# (e.g. IQN), replace the uniform ``mass`` assumption with explicit
# integration over the œÑ intervals.
```

---

## üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ (—É–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)

–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞–Ω—Ç–∏–ª–µ–π:

```python
# –ë—ã–ª–æ:
critic:
  num_quantiles: 32

# –°—Ç–∞–ª–æ:
critic:
  num_quantiles: 64  # –æ—à–∏–±–∫–∞ —Å–Ω–∏–∑–∏—Ç—Å—è –¥–æ ~1-2%
```

**–ö–æ–º–ø—Ä–æ–º–∏—Å—Å:** –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ ~2x –¥–ª—è –∫–≤–∞–Ω—Ç–∏–ª—å–Ω–æ–≥–æ –∫—Ä–∏—Ç–∏–∫–∞.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é)

–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_cvar_from_quantiles` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –ø—Ä–∏ –º–∞–ª—ã—Ö Œ±:

```python
def _cvar_from_quantiles(self, predicted_quantiles: torch.Tensor) -> torch.Tensor:
    alpha = float(self.cvar_alpha)
    num_quantiles = predicted_quantiles.shape[1]

    # –î–ª—è –º–∞–ª—ã—Ö Œ± –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—é –∫ Q(0)
    if alpha < 1.0 / num_quantiles:
        q_first = predicted_quantiles[:, 0]  # Q(0.5/N)
        q_second = predicted_quantiles[:, 1] if num_quantiles > 1 else q_first

        # –õ–∏–Ω–µ–π–Ω–∞—è —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è: Q(0) ‚âà Q(0.5/N) - 0.5*(Q(1.5/N) - Q(0.5/N))
        q_zero = q_first - 0.5 * (q_second - q_first)

        # –ò–Ω—Ç–µ–≥—Ä–∞–ª –æ—Ç 0 –¥–æ alpha —Å –ª–∏–Ω–µ–π–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π
        tau_first = 0.5 / num_quantiles
        weight = alpha / tau_first
        cvar = weight * (q_zero + q_first) / 2.0
        return cvar

    # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
    # ... (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥)
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –∫–≤–∞–Ω—Ç–∏–ª–µ–π –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è CVaR:
- –§—É–Ω–∫—Ü–∏—è `calculate_cvar` (—Å—Ç—Ä–æ–∫–∞ 458) **–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—é–±—ã–µ Œ± –±–µ–∑ —Å–º–µ—â–µ–Ω–∏—è

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ê–£–î–ò–¢–ê

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –§–∞–π–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ | 15+ |
| –§—É–Ω–∫—Ü–∏–π –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ | 10+ |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ | 1000+ |
| –¢–µ—Å—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ | 6+ |
| **–ù–∞–π–¥–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º** | **0** |
| **–ù–∞–π–¥–µ–Ω–æ –≤–∞–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º** | **1** |

---

## üéì –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–û–°–ù–û–í–ê–ù–ò–ï

### –ü–æ—á–µ–º—É –ø—Ä–æ—Å—Ç–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –∫–≤–∞–Ω—Ç–∏–ª–µ–π –¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π EV?

–î–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã—Ö –∫–≤–∞–Ω—Ç–∏–ª–µ–π —Å —Ü–µ–Ω—Ç—Ä–∞–º–∏ œÑ·µ¢ = (i + 0.5)/N:

```
EV = ‚à´‚ÇÄ¬π Q(œÑ) dœÑ

–ú–µ—Ç–æ–¥ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ (midpoint rule):
EV ‚âà Œ£·µ¢ Q(œÑ·µ¢) * (1/N) = mean(Q(œÑ·µ¢))

–û—à–∏–±–∫–∞: O(1/N¬≤) ‚Üê –æ—á–µ–Ω—å –º–∞–ª–∞ –¥–ª—è N=32
```

### –ü–æ—á–µ–º—É CVaR –∏–∑ –∫–≤–∞–Ω—Ç–∏–ª–µ–π –∏–º–µ–µ—Ç —Å–º–µ—â–µ–Ω–∏–µ?

CVaR —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞ —Ç–æ–ª—å–∫–æ –æ—Ç 0 –¥–æ Œ±:

```
CVaRŒ± = (1/Œ±) * ‚à´‚ÇÄ^Œ± Q(œÑ) dœÑ

–ü—Ä–æ–±–ª–µ–º–∞: –î–ª—è Œ± < 1/N –º—ã –Ω–µ –∏–º–µ–µ–º –∫–≤–∞–Ω—Ç–∏–ª–µ–π –≤–Ω—É—Ç—Ä–∏ [0, Œ±]
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Q(0.5/N), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –≤–µ—Å—å –∏–Ω—Ç–µ—Ä–≤–∞–ª [0, 1/N]
```

---

## üìÅ –°–û–ó–î–ê–ù–û –§–ê–ô–õ–û–í

1. **EV_CALCULATIONS_AUDIT_REPORT.md** - –ü–æ–ª–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)
2. **EV_AUDIT_SUMMARY_RU.md** - –≠—Ç–æ —Ä–µ–∑—é–º–µ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º)
3. **test_ev_cvar_analysis.py** - –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —á–∏—Å–ª–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢

- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è EV –∏–∑ –∫–≤–∞–Ω—Ç–∏–ª–µ–π
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è EV –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—ã—á–∏—Å–ª–µ–Ω–∏—è CVaR (–≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—ã—á–∏—Å–ª–µ–Ω–∏—è Explained Variance
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã —Ñ–∞–π–ª—ã risk.py, portfolio_allocator.py, feature_pipe.py
- [x] –ù–∞–π–¥–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–º–µ—â–µ–Ω–∏–µ–º –≤ CVaR
- [x] –ü—Ä–µ–¥–ª–æ–∂–µ–Ω—ã —Ä–µ—à–µ–Ω–∏—è (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)
- [x] –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!** üéâ

---

*–î–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–º–æ—Ç—Ä–∏—Ç–µ EV_CALCULATIONS_AUDIT_REPORT.md*

# Bar-mode execution

Bar execution replaces the per-order runtime with a deterministic,
portfolio-weight driven scheduler.  Signals are sent as signed envelopes that
carry both the desired target and the pre-computed economics.  This page
summarises the envelope format, the built-in cost model and the portfolio
assumptions baked into `impl_bar_executor`.

## Signal envelope

The executor accepts [`SpotSignalEnvelope`](../api/spot_signals.py) messages.
They can be validated against [`docs/spot_signal_envelope.schema.json`](spot_signal_envelope.schema.json),
while the inner payloads have dedicated schemas for the
[`target_weight`](spot_signal_target_weight.schema.json) and
[`delta_weight`](spot_signal_delta_weight.schema.json) variants.

Top-level envelope fields:

- `version`: currently fixed to `"v1"`.
- `symbol`: Binance-style instrument code the rebalance applies to.
- `bar_close_ms`: close timestamp (UTC, milliseconds) of the source bar.
- `expires_at_ms`: millisecond timestamp when the decision should be dropped if
  not executed; it must be greater or equal to `bar_close_ms`.
- `payload`: one of the payload variants described below.
- `signature` *(optional)*: HMAC-SHA256 computed over the canonical payload.

### `target_weight` payload

The [`SpotSignalTargetWeightPayload`](../api/spot_signals.py) schema encodes an
absolute target weight for the upcoming bar.  Required fields are described in
[`docs/spot_signal_target_weight.schema.json`](spot_signal_target_weight.schema.json):

- `kind`: literal `"target_weight"` (implicit when omitted).
- `target_weight`: desired post-trade portfolio weight, clipped to `[0, 1]` by
  the executor.
- `economics`: see [Economics and `act_now`](#economics-and-act_now) for the
  meaning of the nested fields.

### `delta_weight` payload

[`SpotSignalDeltaParticipationPayload`](../api/spot_signals.py) carries a delta
relative to the current weight and optional execution hints documented in
[`docs/spot_signal_delta_weight.schema.json`](spot_signal_delta_weight.schema.json):

- `kind`: literal `"delta_weight"`.
- `delta_weight`: signed adjustment applied on top of the cached portfolio
  weight.
- `participation`: optional suggested participation rate (fraction of ADV) for
  POV-style execution.
- `max_participation`: optional hard cap on participation per slice.
- `twap`: optional [`SpotSignalTwapConfig`](../api/spot_signals.py) block with
  `parts` and cadence hints used to build deterministic child orders.
- `economics`: same structure as in the `target_weight` variant.

## Economics and `act_now`

Each payload bundles [`SpotSignalEconomics`](../api/spot_signals.py) generated by
`decide_spot_trade` in [`impl_bar_executor.py`](../impl_bar_executor.py).  The
helper computes the net edge as:

```
net_bps = edge_bps - (taker_fee_bps + half_spread_bps + impact(participation)) - safety_margin_bps
```

The participation-driven impact term applies the coefficients from
[`SpotCostConfig`](../core_config.py) via the square-root and linear factors in
[`SpotImpactConfig`](../core_config.py).  The resulting economics bundle exposes
the following fields:

- `edge_bps`: raw signal edge in basis points.
- `cost_bps`: estimated execution cost in basis points.
- `net_bps`: post-cost edge after subtracting fees, spread and optional safety
  margin.
- `turnover_usd`: absolute turnover implied by the requested weight change.
- `act_now`: boolean gate.  The executor keeps it `True` only when `net_bps > 0`
  and `turnover_usd > 0`.  When the optional `execution.safety_margin_bps`
  override is present, it is subtracted before this check.
- `impact`: impact estimate (in basis points) contributed by the participation
  model.  Fallback calculations without ADV keep this at `0`.
- `impact_mode`: flag describing how the impact estimate was derived.  The
  default `"model"` indicates the cost model was applied, while `"none"`
  highlights that ADV or volume inputs were unavailable and the impact term was
  suppressed.

Downstream services treat `act_now=False` as permission to defer the rebalance
(e.g. when aggregating multiple signals per bar), while `True` signals must be
consumed immediately.

## Portfolio assumptions

The executor tracks a [`PortfolioState`](../impl_bar_executor.py) per symbol with
three primary inputs:

- `weight`: last known portfolio weight used for delta calculations.
- `equity_usd`: capital base used to convert weight deltas into turnover.
- `price`: bar-level price selected via `execution.bar_price`.

Portfolio data comes from the runtime configuration:
`execution.portfolio.equity_usd` seeds the cached capital base, while
`execution.min_rebalance_step` enforces a minimum trade size as a fraction of
the requested delta.  Absent explicit overrides the defaults collapse to zero,
letting historical PnL reconciliation populate the equity estimate instead.

To integrate a new strategy, keep the cached state aligned with the fills your
venue emits and feed envelopes that respect the schemas above.  The executor
will produce deterministic rebalance instructions that the caller can translate
into exchange-specific orders.

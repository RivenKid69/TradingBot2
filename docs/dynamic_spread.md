# Dynamic Spread Profiles

Dynamic spread profiles allow the simulator to modulate the bid-ask spread by
hour of week. The feature is configured via the `slippage.dynamic` block
in YAML configs (see `configs/config_sim.yaml` for an example). Set
`profile_kind: "hourly"`, enable the block, and either embed the 168
multipliers inline via `multipliers` or point `path` to a JSON profile
generated by the helper script described below.

## JSON format

The helper writes a JSON document with three top-level keys:

```json
{
  "metadata": {
    "generated_at": "2024-05-17T14:32:01.123456+00:00",
    "source": "data/seasonality_source/latest.parquet",
    "profile_kind": "hourly",
    "window_days": 90,
    "normalization": "mean = 1.0",
    "symbol": "BTCUSDT",
    "samples": 123456,
    "overall_mean_spread": 0.00012
  },
  "profile": [1.0, 1.02, ...],
  "hourly_raw": [0.00012, 0.00011, ...],
  "counts": [2048, 1987, ...]
}
```

* `profile` contains the normalised multipliers used by the simulator. They
  always average to `1.0`.
* `hourly_raw` stores the mean spread metric per hour of week before
  normalisation.
* `counts` records the number of samples per hour, which is useful when
  checking coverage.
* `metadata` captures provenance information, including the source dataset,
  time window and the command parameters.

## Building a profile

Use `scripts/build_spread_seasonality.py` to aggregate spread metrics and write
an updated profile:

```bash
python scripts/build_spread_seasonality.py \
  --data data/seasonality_source/latest.parquet \
  --out data/slippage/hourly_profile.json \
  --window-days 90 \
  --symbol BTCUSDT
```

Key options:

* `--window-days` – restricts the computation to the most recent N days.
* `--out` – destination JSON file used by the simulator.
* `--spread-column` – overrides the auto-detected spread column. If omitted,
  the script falls back to `(high - low) / mid`.
* `--refresh-warn-days` – emits a warning when the historical snapshot is older
  than the configured number of days. The warning mirrors the
  `refresh_warn_days` guard in `DynamicSpreadConfig` and helps operators notice
  stale inputs before running backtests.

The resulting JSON can be referenced from configs via
`slippage.dynamic.path`. To roll out a refreshed profile:

1. Download or export the latest historical bars to Parquet/CSV.
2. Run the helper script with the desired options.
3. Commit the new JSON and its checksum (if applicable).
4. Update `slippage.dynamic.hash` when configs track file integrity.
5. Restart services or allow the auto-reloader (if enabled) to pick up the new
   profile.

Keep the raw dataset under `data/seasonality_source/` (or an equivalent
location) to facilitate reproducibility and audits.

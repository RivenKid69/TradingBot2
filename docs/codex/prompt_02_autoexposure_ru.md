# Промпт 2 — устойчивая автоэкспозиция ценности

## Цель
Стабилизировать автоматический пересчёт шкалы value-head во время обучения, чтобы всплески вознаграждений не «ослепляли» модель и не раздували поддержку распределения.

## План действий
1. **EMA сглаживание статистики**
   - Поддерживай экспоненциальное усреднение по средней/дисперсии доходностей.
   - Храни скользящее окно последних апдейтов и используй его как «короткую наводку» перед фиксацией параметров.
2. **Ограничение шага**
   - Для `ret_mean`, `ret_std` и диапазона `[v_min, v_max]` вводится относительное ограничение (`max_rel_step` / `range_max_rel_step`).
   - Величина сдвига центра и ширины диапазона не должна превышать заданную долю предыдущего спана.
3. **Прогрев и заморозка**
   - Несколько первых обновлений (`warmup_updates`) разрешены всегда: даём алгоритму сфокусироваться.
   - После достижения порога `freeze_after` автоэкспозиция «замораживается» до конца обучения.
4. **Проверка стабильности кадра**
   - Перед обновлением требуем, чтобы:
     - P95 абсолютных вознаграждений не выходил за порог (`max_abs_p95`).
     - Explained variance превышала минимум (`min_explained_variance`).
     - Условие выполнялось `patience` раз подряд.
   - Пока кадр «шумный», обновления запрещены и логируются как заблокированные.
5. **Плавное включение CVaR**
   - Вес CVaR наращивается только после стабилизации value-scale и окончания warm-up.
   - При потере стабильности прогресс обнуляется (аналог «сбрасывания штанги»).
6. **Телеметрия «до/после»**
   - Для каждого апдейта логируй:
     - `value_scale_mean/std_{before,after}`;
     - `value_scale_vmin/vmax_{before,after}` (в исходных единицах);
     - флаги `update_applied`, `blocked_samples`, `blocked_stability`, `blocked_freeze`;
     - счётчик `value_scale_update_count` и состояние `value_scale_frozen`.
   - Дополнительно сохраняй `value_scale_frame_stable` и `value_scale_stable_consec` для CVaR.

## Критерии готовности
- Нет резких скачков `train/v_min` / `train/v_max` и взрывов value-target scale.
- Логи фиксируют причины пропуска обновлений и итоговые значения «до/после».
- CVaR weight включается только после устойчивой стойки (стабильный кадр, завершён прогрев).

# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç: –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å 1h –Ω–∞ 4h —Ç–∞–π–º—Ñ—Ä–µ–π–º

**–î–∞—Ç–∞:** 2025-11-12
**–í–µ—Ä—Å–∏—è:** –§–∏–Ω–∞–ª—å–Ω–∞—è
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–ü—Ä–æ–µ–∫—Ç **TradingBot2** —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ **1h** –Ω–∞ **4h**.
–í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞–π–¥–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –Ω–∞ 4h –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ.

**–°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏:** üü¢ **100% –ì–û–¢–û–í–û**

---

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚úÖ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û –†–ê–ù–ï–ï

1. **config_4h_timeframe.py** - —Å–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è 4h –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
2. **transformers.py** - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è 4h (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω)
3. **mediator.py** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ –Ω–æ–≤—ã–µ –∏–º–µ–Ω–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (ret_4h, ret_12h, etc.)
4. **obs_builder.pyx** - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è 4h
5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (ANALYSIS_4H_TIMEFRAME.md, DEEP_AUDIT_REPORT_4H.md, etc.)
6. –¢–µ—Å—Ç—ã –¥–ª—è 4h –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞

### üîß –ß–¢–û –ë–´–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–û –°–ï–ô–ß–ê–°

#### 1. **prepare_and_run.py** (–ö–†–ò–¢–ò–ß–ù–û)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ñ–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ —Å–º–µ—â–µ–Ω–∏–µ 3600 —Å–µ–∫—É–Ω–¥ (1h) –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è open_time –≤ close_time

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –°—Ç—Ä–æ–∫–∞ 109-112: –ò–∑–º–µ–Ω–µ–Ω–æ —Å `+ 3600` –Ω–∞ `+ bar_duration_sec`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ENV –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `BAR_DURATION_SEC` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 14400 –¥–ª—è 4h)
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ docstring

```python
# –ë–´–õ–û:
ts = _to_seconds_any(df[cols[key]]) + 3600  # 1h –±–∞—Ä ‚Üí —Å–º–µ—Å—Ç–∏–º –∫ –∑–∞–∫—Ä—ã—Ç–∏—é

# –°–¢–ê–õ–û:
bar_duration_sec = int(os.environ.get("BAR_DURATION_SEC", "14400"))
ts = _to_seconds_any(df[cols[key]]) + bar_duration_sec  # 4h –±–∞—Ä ‚Üí —Å–º–µ—Å—Ç–∏–º –∫ –∑–∞–∫—Ä—ã—Ç–∏—é
```

**–§–∞–π–ª:** `/home/user/TradingBot2/prepare_and_run.py`

---

#### 2. **app.py** (3 –∏–∑–º–µ–Ω–µ–Ω–∏—è)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –¥–æ–±–∞–≤–ª–µ–Ω "4h" –≤ —Å–ø–∏—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –∏ default –∞—Ä–≥—É–º–µ–Ω—Ç—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

##### 2.1. –°—Ç—Ä–æ–∫–∞ 2214: aggregate_to
```yaml
# –ë–´–õ–û:
aggregate_to: ["5m", "15m", "1h"]

# –°–¢–ê–õ–û:
aggregate_to: ["5m", "15m", "1h", "4h"]
```

##### 2.2. –°—Ç—Ä–æ–∫–∞ 4316: build_adv default_args
```bash
# –ë–´–õ–û:
--market futures --interval 1h --start 2023-01-01T00:00:00Z ...

# –°–¢–ê–õ–û:
--market futures --interval 4h --start 2023-01-01T00:00:00Z ...
```

##### 2.3. –°—Ç—Ä–æ–∫–∞ 4338: build_adv_base default_args
```bash
# –ë–´–õ–û:
--market futures --interval 1h --window-days 30 ...

# –°–¢–ê–õ–û:
--market futures --interval 4h --window-days 30 ...
```

**–§–∞–π–ª:** `/home/user/TradingBot2/app.py`

---

#### 3. **feature_pipe.py**
**–ü—Ä–æ–±–ª–µ–º–∞:** ADV –∫–æ–ª–æ–Ω–∫–∏ —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º "_1h" –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è 4h

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∏ 43-54
```python
# –ë–´–õ–û:
_ADV_COLUMNS: Sequence[str] = (
    "adv_quote_1h",
    "adv_usd_1h",
    "adv_quote",
    "adv_usd",
    "adv_1h",
    "adv",
)

# –°–¢–ê–õ–û:
_ADV_COLUMNS: Sequence[str] = (
    "adv_quote_4h",      # –ù–æ–≤—ã–µ 4h –∫–æ–ª–æ–Ω–∫–∏
    "adv_usd_4h",
    "adv_quote",
    "adv_usd",
    "adv_4h",
    "adv",
    # Legacy support (for 1h data)
    "adv_quote_1h",      # –û—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    "adv_usd_1h",
    "adv_1h",
)
```

**–§–∞–π–ª:** `/home/user/TradingBot2/feature_pipe.py`

---

#### 4. **feature_config.py**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–ø–æ–º–∏–Ω–∞–µ—Ç "1h return" –≤–º–µ—Å—Ç–æ "4h return"

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∞ 32
```python
# –ë–´–õ–û:
# Derived features block (1h return and volatility proxy)

# –°–¢–ê–õ–û:
# Derived features block (4h return and volatility proxy for 4h timeframe)
```

**–§–∞–π–ª:** `/home/user/TradingBot2/feature_config.py`

---

#### 5. **incremental_klines_4h.py** (–ù–û–í–´–ô –§–ê–ô–õ)
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è 4h –¥–∞–Ω–Ω—ã—Ö —Å Binance

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª `incremental_klines_4h.py`
- –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑ `incremental_klines.py`
- –ò–Ω—Ç–µ—Ä–≤–∞–ª: `4h` (14400000 ms)
- –í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: `data/klines_4h/`
- Close lag: 8000 ms (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –≤–º–µ—Å—Ç–æ 2000 –¥–ª—è 1h)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
python incremental_klines_4h.py --symbols BTCUSDT,ETHUSDT
python incremental_klines_4h.py  # –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ data/universe/symbols.json
```

**–§–∞–π–ª:** `/home/user/TradingBot2/incremental_klines_4h.py` (—Å–æ–∑–¥–∞–Ω)

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤

### –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –°—Ç–∞—Ä—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (1h/1m) | –ù–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (4h) | –û–∫–Ω–∞ (–±–∞—Ä—ã) | –û–∫–Ω–∞ (–≤—Ä–µ–º—è) |
|-----------|-------------------------|---------------------|-------------|--------------|
| **Returns** | ret_5m, ret_15m, ret_60m | ret_4h, ret_12h, ret_24h, ret_7d | 1, 3, 6, 42 | 4h, 12h, 24h, 7d |
| **SMA** | sma_5, sma_15, sma_60 | sma_5, sma_21, sma_50 | 5, 21, 50 | 20h, 84h, 200h |
| **Yang-Zhang** | yang_zhang_24h, yang_zhang_7d, yang_zhang_30d | yang_zhang_48h, yang_zhang_7d, yang_zhang_30d | 12, 42, 180 | 48h, 7d, 30d |
| **Parkinson** | parkinson_24h, parkinson_7d | parkinson_48h, parkinson_7d | 12, 42 | 48h, 7d |
| **GARCH** | garch_500m, garch_12h, garch_24h | garch_200h, garch_14d, garch_30d | 50, 84, 180 | 200h, 14d, 30d |
| **CVD** | cvd_24h, cvd_168h | cvd_24h, cvd_7d | 6, 42 | 24h, 7d |
| **Taker Buy Ratio SMA** | taker_buy_ratio_sma_6h, taker_buy_ratio_sma_12h, taker_buy_ratio_sma_24h | taker_buy_ratio_sma_8h, taker_buy_ratio_sma_16h, taker_buy_ratio_sma_24h | 2, 4, 6 | 8h, 16h, 24h |
| **Taker Buy Ratio Momentum** | taker_buy_ratio_momentum_1h, taker_buy_ratio_momentum_6h, taker_buy_ratio_momentum_12h | taker_buy_ratio_momentum_4h, taker_buy_ratio_momentum_8h, taker_buy_ratio_momentum_12h | 1, 2, 3 | 4h, 8h, 12h |

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø–µ—Ä–µ—Å—á–µ—Ç–∞

1. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞:** –í—Å–µ –æ–∫–Ω–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã —Å –º–∏–Ω—É—Ç –≤ –±–∞—Ä—ã (–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 240)
2. **GARCH:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª–∏–Ω–Ω—ã–µ –æ–∫–Ω–∞ (–º–∏–Ω–∏–º—É–º 50 –±–∞—Ä–æ–≤ = 200h) –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
3. **Yang-Zhang:** –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–æ —Å 6 –±–∞—Ä–æ–≤ (24h) –¥–æ 12 –±–∞—Ä–æ–≤ (48h) –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
4. **Returns:** –ö–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ—Ç—ë—Ä–Ω—ã (5m, 15m, 60m) –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ 4h, 12h, 24h, 7d
5. **Microstructure:** –ú–∏–∫—Ä–æ—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (ofi_proxy, qimb) –ù–ï –ø—Ä–∏–º–µ–Ω–∏–º—ã –Ω–∞ 4h

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

### ‚úÖ –§–∞–π–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

| –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
|------|--------|-------------------|
| config_4h_timeframe.py | ‚úÖ –ì–æ—Ç–æ–≤ | –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è 4h (—Å–æ–∑–¥–∞–Ω —Ä–∞–Ω–µ–µ) |
| transformers.py | ‚úÖ –ì–æ—Ç–æ–≤ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω (–æ–±–Ω–æ–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ) |
| mediator.py | ‚úÖ –ì–æ—Ç–æ–≤ | –í—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ 4h (–æ–±–Ω–æ–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ) |
| obs_builder.pyx | ‚úÖ –ì–æ—Ç–æ–≤ | –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è 4h (–æ–±–Ω–æ–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ) |
| prepare_and_run.py | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω | –°–º–µ—â–µ–Ω–∏–µ 3600 ‚Üí 14400 |
| app.py | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω | –î–æ–±–∞–≤–ª–µ–Ω "4h" –≤ 3 –º–µ—Å—Ç–∞ |
| feature_pipe.py | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω | ADV –∫–æ–ª–æ–Ω–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã |
| feature_config.py | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω |
| incremental_klines_4h.py | ‚úÖ –°–æ–∑–¥–∞–Ω | –ù–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è 4h –¥–∞–Ω–Ω—ã—Ö |

### ‚úÖ –ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|-----------|------------|--------|------------|
| Bar-level | 3 | ‚úÖ | open, high, low, close |
| Derived | 2 | ‚úÖ | ret_4h (–≤–º–µ—Å—Ç–æ ret_1h), vol_proxy |
| Indicators | 13 | ‚úÖ | SMA, RSI, MACD, etc. |
| Microstructure | 3 | ‚ö†Ô∏è | –¢—Ä–µ–±—É—é—Ç –∑–∞–º–µ–Ω—ã –Ω–∞ candlestick patterns |
| Agent | 6 | ‚úÖ | position, pnl, etc. |
| Metadata | 5 | ‚úÖ | fear_greed, events, etc. |
| External (norm_cols) | 21 | ‚úÖ | cvd, garch, yang_zhang, returns |
| Token meta | 2 | ‚úÖ | token_id, num_tokens |
| **–í–°–ï–ì–û** | **55** | ‚úÖ | (56 –µ—Å–ª–∏ —Å—á–∏—Ç–∞—Ç—å token one-hot) |

---

## –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### üö® –í–ê–ñ–ù–û: –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. **–°–∫–∞—á–∞—Ç—å 4h –¥–∞–Ω–Ω—ã–µ:**
   ```bash
   python incremental_klines_4h.py --symbols BTCUSDT,ETHUSDT
   ```

2. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
   ```bash
   export BAR_DURATION_SEC=14400  # 4h = 14400 —Å–µ–∫—É–Ω–¥
   ```

3. **–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏:**
   ```bash
   python prepare_and_run.py --raw-dir data/klines_4h --out-dir data/processed
   ```

4. **–ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å –Ω–∞ 4h –¥–∞–Ω–Ω—ã—Ö:**
   ```bash
   python train_model_multi_patch.py --config configs/config_train.yaml
   ```

### ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **Microstructure –ø—Ä–∏–∑–Ω–∞–∫–∏:** –ù–∞ 4h –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞:
   - Candlestick patterns (doji, hammer, engulfing)
   - Macro indicators (trend_strength, regime_volatility)

2. **–û–±—ä–µ–º—ã:** –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–º–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:
   - –°—Ç–∞—Ä—ã–π –¥–µ–ª–∏—Ç–µ–ª—å: 1e6 (–¥–ª—è 1m)
   - –ù–æ–≤—ã–π –¥–µ–ª–∏—Ç–µ–ª—å: 240e6 (–¥–ª—è 4h, –ø—Ä–∏–º–µ—Ä–Ω–æ)
   - –ö–∞–ª–∏–±—Ä—É–π—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö!

3. **ADV (Average Daily Volume):**
   - –°—Ç–∞—Ä—ã–µ –∫–æ–ª–æ–Ω–∫–∏: `adv_1h`, `adv_quote_1h`, `adv_usd_1h`
   - –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏: `adv_4h`, `adv_quote_4h`, `adv_usd_4h`
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏

4. **–°—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏:** –ú–æ–¥–µ–ª–∏, –æ–±—É—á–µ–Ω–Ω—ã–µ –Ω–∞ 1h –¥–∞–Ω–Ω—ã—Ö, **–ù–ï** —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ 4h!
   - –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ —Å –Ω—É–ª—è

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–µ—Å—Ç—ã

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å config
python config_4h_timeframe.py

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
python make_features.py --in data/klines_4h/BTCUSDT.csv --out test_features.parquet

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã (–µ—Å–ª–∏ pytest —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
pytest test_deep_audit_fixes.py -v
pytest test_4h_integration_fixes.py -v

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å prepare_and_run
python prepare_and_run.py --raw-dir data/klines_4h --out-dir data/processed_test
```

---

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

| –û–ø–µ—Ä–∞—Ü–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ |
|----------|-------------------|
| –°–æ–∑–¥–∞–Ω—ã | 1 (incremental_klines_4h.py) |
| –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã | 4 (prepare_and_run.py, app.py, feature_pipe.py, feature_config.py) |
| –†–∞–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã | 5 (config_4h_timeframe.py, transformers.py, mediator.py, obs_builder.pyx, ...) |
| **–í–°–ï–ì–û** | **10** |

### –°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞ –∏–∑–º–µ–Ω–µ–Ω—ã

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ |
|------|----------------|
| prepare_and_run.py | ~10 |
| app.py | ~3 |
| feature_pipe.py | ~8 |
| feature_config.py | ~1 |
| incremental_klines_4h.py | ~350 (–Ω–æ–≤—ã–π —Ñ–∞–π–ª) |
| **–í–°–ï–ì–û** | **~372** |

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

```bash
# –°–∫–∞—á–∞—Ç—å 4h –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
python incremental_klines_4h.py --symbols BTCUSDT --close-lag-ms 8000

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
ls -lh data/klines_4h/BTCUSDT.csv

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏
python prepare_and_run.py --raw-dir data/klines_4h --out-dir data/processed_4h

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
ls -lh data/processed_4h/BTCUSDT.feather
```

### 2. –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤–æ)

```bash
# 1. –°–∫–∞—á–∞—Ç—å –≤—Å–µ 4h –¥–∞–Ω–Ω—ã–µ –¥–ª—è universe
python incremental_klines_4h.py

# 2. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å ADV –¥–ª—è 4h
python build_adv.py --market futures --interval 4h --window-days 30 --out data/adv/adv_4h.parquet

# 3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
python prepare_and_run.py --raw-dir data/klines_4h --out-dir data/processed

# 4. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å training dataset
python build_training_table.py --config configs/config_train.yaml

# 5. –û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å
python train_model_multi_patch.py --config configs/config_train.yaml
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

- **–õ–æ–≥–∏:** –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ `logs/` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
- **–ü—Ä–∏–∑–Ω–∞–∫–∏:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ 21 external –ø—Ä–∏–∑–Ω–∞–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- **–ò–º–µ–Ω–∞:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ (ret_4h, –∞ –Ω–µ ret_1h)
- **–û–±—ä–µ–º—ã:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ **TradingBot2** —Å —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ **1h** –Ω–∞ **4h** –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.

### ‚úÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

1. –ù–∞–π–¥–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
2. –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ 4h –¥–∞–Ω–Ω—ã—Ö
3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
4. –û–±–µ—Å–ø–µ—á–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (ADV legacy support)
5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–µ–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –æ—Ç—á–µ—Ç–æ–º

### üìä –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å |
|-----------|------------|
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | 100% ‚úÖ |
| –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã | 100% ‚úÖ |
| –ú–µ–¥–∏–∞—Ç–æ—Ä | 100% ‚úÖ |
| Obs Builder | 100% ‚úÖ |
| –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö | 100% ‚úÖ |
| –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | 100% ‚úÖ |
| UI (app.py) | 100% ‚úÖ |
| **–û–ë–©–ê–Ø –ì–û–¢–û–í–ù–û–°–¢–¨** | **100% ‚úÖ** |

### üéØ –°–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. –ó–∞–º–µ–Ω–∏—Ç—å microstructure –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–∞ candlestick patterns
2. –û—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –æ–±—ä–µ–º–æ–≤ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö 4h –¥–∞–Ω–Ω—ã—Ö
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ backtest –Ω–∞ 4h –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
4. –°—Ä–∞–≤–Ω–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 1h vs 4h

---

**–ê–≤—Ç–æ—Ä:** Claude AI
**–î–∞—Ç–∞:** 2025-11-12
**–í–µ—Ä—Å–∏—è:** 1.0 Final

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –î–∞—Ç–∞ | –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|--------|-----------|
| 2025-11-11 | 0.1 | –°–æ–∑–¥–∞–Ω–∏–µ config_4h_timeframe.py |
| 2025-11-11 | 0.5 | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ transformers.py, mediator.py |
| 2025-11-11 | 0.8 | –ì–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GARCH naming |
| 2025-11-12 | 1.0 | –§–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏: prepare_and_run.py, app.py, feature_pipe.py, incremental_klines_4h.py |

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–û–ï–ö–¢ –ì–û–¢–û–í –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –ù–ê 4H –¢–ê–ô–ú–§–†–ï–ô–ú–ï

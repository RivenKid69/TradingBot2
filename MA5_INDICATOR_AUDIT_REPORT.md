# –û–¢–ß–ï–¢ –û–ë –ê–£–î–ò–¢–ï –ü–†–ò–ó–ù–ê–ö–ê MA5 (5-–ü–ï–†–ò–û–î–ù–û–ï –°–ö–û–õ–¨–ó–Ø–©–ï–ï –°–†–ï–î–ù–ï–ï)

**–î–∞—Ç–∞:** 2025-11-16
**–ü—Ä–∏–∑–Ω–∞–∫:** ma5 (–∏–Ω–¥–µ–∫—Å 3, sma_1200 –¥–ª—è 4h —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞)
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** transformers.py:859-867, mediator.py:1083, obs_builder.pyx:237-240
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û**

---

## EXECUTIVE SUMMARY

–ü–æ—Å–ª–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞ –ø—Ä–∏–∑–Ω–∞–∫–∞ ma5 (5-–ø–µ—Ä–∏–æ–¥–Ω–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:

1. ‚úÖ **Look-ahead bias –û–¢–°–£–¢–°–¢–í–£–ï–¢** - –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ –±—ã–ª–∞ –õ–û–ñ–ù–û–ô
2. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–µ–º–∞–Ω—Ç–∏–∫—É "end-of-bar decision making"
3. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ LeakGuard + decision_delay_ms
4. ‚úÖ –ß–∏—Å–ª–µ–Ω–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–∫–æ–Ω
5. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ NaN —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å —Ñ–ª–∞–≥–æ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
6. ‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–æ–∂–Ω—ã—Ö —Ç—Ä–µ–≤–æ–≥

---

## 1. –ê–ù–ê–õ–ò–ó –ü–†–ï–î–ü–û–õ–ê–ì–ê–ï–ú–´–• –ü–†–û–ë–õ–ï–ú

### 1.1. Look-ahead Bias (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô —Ä–∏—Å–∫) - –õ–û–ñ–ù–ê–Ø –¢–†–ï–í–û–ì–ê

**–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞:**
–ö–æ–¥ –≤ transformers.py:804-867 –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –≤ —Å–ø–∏—Å–æ–∫ –ü–ï–†–ï–î –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º SMA, —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç look-ahead bias.

```python
st["prices"].append(price)         # –°—Ç—Ä–æ–∫–∞ 804: –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
seq = list(st["prices"])           # –°—Ç—Ä–æ–∫–∞ 856: —Å–ø–∏—Å–æ–∫ –í–ö–õ–Æ–ß–ê–ï–¢ —Ç–µ–∫—É—â—É—é
window = seq[-lb:]                 # –°—Ç—Ä–æ–∫–∞ 864: –ø–æ—Å–ª–µ–¥–Ω–∏–µ lb —ç–ª–µ–º–µ–Ω—Ç–æ–≤
sma = sum(window) / float(lb)      # –í–∫–ª—é—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:** ‚ùå **–ì–ò–ü–û–¢–ï–ó–ê –õ–û–ñ–ù–ê**

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
–ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ü–†–ê–í–ò–õ–¨–ù–û —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (Murphy, 1999):

1. **–°–µ–º–∞–Ω—Ç–∏–∫–∞ –≤—ã–∑–æ–≤–∞:**
   - `update()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï –∑–∞–∫—Ä—ã—Ç–∏—è –±–∞—Ä–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ó–ê–ö–†–´–¢–û–ì–û –±–∞—Ä–∞
   - ts_ms = –≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è –±–∞—Ä–∞
   - close = —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ó–ê–ö–†–´–¢–û–ì–û –±–∞—Ä–∞

2. **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ SMA:**
   - SMA_5 = (P_t + P_{t-1} + P_{t-2} + P_{t-3} + P_{t-4}) / 5
   - –≥–¥–µ P_t = —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –¢–ï–ö–£–©–ï–ì–û (—Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ) –±–∞—Ä–∞
   - –≠—Ç–æ –°–¢–ê–ù–î–ê–†–¢–ù–û–ï –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ TA

3. **–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–±–µ–∑ —É—Ç–µ—á–∫–∏):**
   ```
   t0: –ë–∞—Ä –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç ts_ms
   t1: update() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –±–∞—Ä–∞
   t2: –ü—Ä–∏–∑–Ω–∞–∫–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   t3: –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –≤ decision_ts = ts_ms + decision_delay_ms
   t4: Target = –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –æ—Ç decision_ts –¥–æ decision_ts + horizon_ms
   ```

4. **–ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏:**
   - LeakGuard –¥–æ–±–∞–≤–ª—è–µ—Ç decision_delay_ms > 0
   - Target –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ—Ç decision_ts (–ù–ï –æ—Ç ts_ms)
   - build_training_table.py:59: `lg = LeakGuard(LeakConfig(decision_delay_ms=...))`
   - labels.py:40-52: Target –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –æ—Ç decision_ts

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑ —Ç–µ—Å—Ç–æ–≤:**
test_critical_verification.py:297-322:
```python
# sma_240 (lb=1): —Å—Ä–µ–¥–Ω–µ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ 1 —ç–ª–µ–º–µ–Ω—Ç–∞ = 110
expected_sma1 = 110.0  # –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞!

# sma_720 (lb=3): —Å—Ä–µ–¥–Ω–µ–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ = (106+108+110)/3
expected_sma3 = (106.0 + 108.0 + 110.0) / 3.0  # –í–∫–ª—é—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é!
```

**–ü–æ—á–µ–º—É –≤–æ–∑–Ω–∏–∫–ª–∞ –ª–æ–∂–Ω–∞—è —Ç—Ä–µ–≤–æ–≥–∞:**
–ê–≤—Ç–æ—Ä –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω—è–ª —Å–µ–º–∞–Ω—Ç–∏–∫—É, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è —á—Ç–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–æ–ª–∂–Ω—ã –≤—ã—á–∏—Å–ª—è—Ç—å—Å—è –ë–ï–ó —Ç–µ–∫—É—â–µ–≥–æ –±–∞—Ä–∞. –≠—Ç–æ –±—ã–ª–æ –±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¢–û–õ–¨–ö–û –¥–ª—è intra-bar trading —Å–∏—Å—Ç–µ–º, –Ω–æ –ù–ï –¥–ª—è end-of-bar —Å–∏—Å—Ç–µ–º (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –≤ ML trading).

---

### 1.2. NaN –ø—Ä–∏ —Ö–æ–ª–æ–¥–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ (–ù–ò–ó–ö–ò–ô —Ä–∏—Å–∫) - ‚úÖ –ö–û–†–†–ï–ö–¢–ù–û

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** obs_builder.pyx:237-240
```python
ma5_valid = not isnan(ma5)
out_features[3] = ma5 if ma5_valid else 0.0
out_features[4] = 1.0 if ma5_valid else 0.0  # –§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
**–†–∏—Å–∫:** –ù–ò–ó–ö–ò–ô (—Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ ML)
**–î–µ–π—Å—Ç–≤–∏—è:** –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è

---

### 1.3. –ó–∞–ø–∞–∑–¥—ã–≤–∞–Ω–∏–µ (lag) –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (–°–†–ï–î–ù–ò–ô —Ä–∏—Å–∫) - ‚ö†Ô∏è –î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–ù–û

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü—Ä–∏—Ä–æ–¥–∞ SMA

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- SMA –∏–º–µ–µ—Ç inherent lag ‚âà window/2 (Murphy, 1999)
- –î–ª—è SMA_5: lag ‚âà 2.5 –±–∞—Ä–∞ (10 —á–∞—Å–æ–≤ –¥–ª—è 4h —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞)
- –≠—Ç–æ –ü–†–ò–°–£–©–ï –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É, –ù–ï —è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–æ–π

**–†–∏—Å–∫:** –°–†–ï–î–ù–ò–ô - –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ —É—á–∏—Ç—ã–≤–∞—Ç—å lag –ø—Ä–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
**–î–µ–π—Å—Ç–≤–∏—è:** ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ transformers.py:732-735

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (–ù–ï –∫—Ä–∏—Ç–∏—á–Ω–∞):**
–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å EMA (Exponential Moving Average) –≤–º–µ—Å—Ç–æ SMA –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è lag:
- EMA –∏–º–µ–µ—Ç –º–µ–Ω—å—à–∏–π lag –ø—Ä–∏ —Ç–æ–º –∂–µ –æ–∫–Ω–µ
- –ë–æ–ª—å—à–∏–π –≤–µ—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
- –¢—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–∞ –º–æ–¥–µ–ª—å

---

### 1.4. –ß–∏—Å–ª–µ–Ω–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å float32 (–ù–ò–ó–ö–ò–ô —Ä–∏—Å–∫) - ‚úÖ –ü–†–ò–ï–ú–õ–ï–ú–û

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** transformers.py:865
```python
sma = sum(window) / float(lb)
```

**–ê–Ω–∞–ª–∏–∑:**
- –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–∫–Ω–∞: 1-50 –±–∞—Ä–æ–≤ (ma5 = 5 –±–∞—Ä–æ–≤)
- –¶–µ–Ω—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∫–Ω–∞ (40000-50000 –¥–ª—è BTC)
- –ü–æ—Ç–µ—Ä—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ < 1e-6 –¥–ª—è —Ç–∞–∫–∏—Ö –æ–∫–æ–Ω
- Kahan summation –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è (–∏–∑–±—ã—Ç–æ—á–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ü–†–ò–ï–ú–õ–ï–ú–û
**–†–∏—Å–∫:** –ù–ò–ó–ö–ò–ô
**–î–µ–π—Å—Ç–≤–∏—è:** –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è

---

## 2. –ü–†–û–í–ï–†–ï–ù–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´

### 2.1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SMA (transformers.py:859-867)

```python
for i, lb in enumerate(self.spec.lookbacks_prices):
    lb_minutes = self.spec._lookbacks_prices_minutes[i]
    if len(seq) >= lb:
        window = seq[-lb:]  # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ø–æ—Å–ª–µ–¥–Ω–∏–µ lb –∑–∞–∫—Ä—ã—Ç—ã—Ö –±–∞—Ä–æ–≤
        sma = sum(window) / float(lb)
        feats[f"sma_{lb_minutes}"] = float(sma)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–û–†–†–ï–ö–¢–ù–û

---

### 2.2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∞ (mediator.py:1083)

```python
ma5 = self._get_safe_float(row, "sma_1200", float('nan'))
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–û–†–†–ï–ö–¢–ù–û
**Fallback:** NaN –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö

---

### 2.3. –û–±—Ä–∞–±–æ—Ç–∫–∞ NaN (obs_builder.pyx:237-240)

```python
ma5_valid = not isnan(ma5)
out_features[3] = ma5 if ma5_valid else 0.0
out_features[4] = 1.0 if ma5_valid else 0.0  # Validity flag
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–û–†–†–ï–ö–¢–ù–û
**Best practice:** –î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞ (–∑–Ω–∞—á–µ–Ω–∏–µ + —Ñ–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏)

---

### 2.4. –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏ (LeakGuard + LabelBuilder)

**LeakGuard (build_training_table.py:59):**
```python
lg = LeakGuard(LeakConfig(decision_delay_ms=int(args.decision_delay_ms), min_lookback_ms=0))
merged = lg.attach_decision_time(merged, ts_col="ts_ms")
```

**LabelBuilder (labels.py:40-52):**
```python
# t0 = decision_ts (–ù–ï ts_ms!)
# t1 = decision_ts + horizon_ms
# price0 = forward lookup –æ—Ç decision_ts
# price1 = forward lookup –æ—Ç decision_ts + horizon
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–û–†–†–ï–ö–¢–ù–û
**–ó–∞—â–∏—Ç–∞:** decision_delay_ms –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –±—É—Ñ–µ—Ä

---

## 3. –í–ù–ï–°–ï–ù–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### 3.1. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫–ª–∞—Å—Å–∞ OnlineFeatureTransformer (transformers.py:705-741)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–µ–º–∞–Ω—Ç–∏–∫–∏ "end-of-bar decision making"
- –§–æ—Ä–º—É–ª—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç —É—Ç–µ—á–∫–∏ —á–µ—Ä–µ–∑ decision_delay_ms
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ lag –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
- –°—Å—ã–ª–∫–∏ –Ω–∞ Murphy (1999) –∏ de Prado (2018)

---

### 3.2. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ update() (transformers.py:802-843)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–∞
- –ß–µ—Ç–∫–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ó–ê–ö–†–´–¢–´–ú–ò –±–∞—Ä–∞–º–∏
- –§–æ—Ä–º—É–ª—ã –≤—Å–µ—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
- Note –æ –ø—Ä–∏—Ä–æ–¥–Ω–æ–º lag –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤

---

## 4. –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê –†–ò–°–ö–û–í

| –ü—Ä–æ–±–ª–µ–º–∞                       | –†–∏—Å–∫      | –°—Ç–∞—Ç—É—Å       | –î–µ–π—Å—Ç–≤–∏—è           |
|--------------------------------|-----------|--------------|-------------------|
| NaN –ø—Ä–∏ —Ö–æ–ª–æ–¥–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ        | –ù–ò–ó–ö–ò–ô    | ‚úÖ –ó–∞—â–∏—â–µ–Ω   | –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è      |
| –ó–∞–ø–∞–∑–¥—ã–≤–∞–Ω–∏–µ (lag)             | –°–†–ï–î–ù–ò–ô   | ‚ö†Ô∏è Inherent  | ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ|
| Look-ahead bias                | ‚ùå –õ–û–ñ–ù–û  | ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç| ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ|
| –¢–æ—á–Ω–æ—Å—Ç—å float32               | –ù–ò–ó–ö–ò–ô    | ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞| –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è      |
| –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è     | –°–†–ï–î–ù–ò–ô   | ‚ö†Ô∏è –ë—ã–ª–æ      | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ     |

---

## 5. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 5.1. –°–û–•–†–ê–ù–ò–¢–¨ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
‚úÖ –§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–ª—è NaN –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚úÖ –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è SMA (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π –±–∞—Ä)
‚úÖ –ó–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ LeakGuard + decision_delay_ms
‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Å—É–º–º–∞ –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –æ–∫–æ–Ω

### 5.2. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
‚ö†Ô∏è **EMA –≤–º–µ—Å—Ç–æ SMA** - –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è lag (—Ç—Ä–µ–±—É–µ—Ç A/B testing)
‚ö†Ô∏è **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –æ–∫–Ω–∞** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
‚ö†Ô∏è **Weighted MA** - –±–æ–ª—å—à–∏–π –≤–µ—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

### 5.3. –ú–û–ù–ò–¢–û–†–ò–ù–ì
üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å decision_delay_ms –≤ production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
üìä A/B —Ç–µ—Å—Ç –≤–ª–∏—è–Ω–∏—è lag –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ NaN rate –≤ production

---

## 6. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–§–∏–Ω–∞–ª—å–Ω—ã–π –≤–µ—Ä–¥–∏–∫—Ç:** ‚úÖ **–°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û**

–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ –æ look-ahead bias –±—ã–ª–∞ **–õ–û–ñ–ù–û–ô**. –ö–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä—ã–Ω–∫–æ–≤:

1. ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ó–ê–ö–†–´–¢–´–• –±–∞—Ä–æ–≤ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç TA)
2. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ decision_delay_ms
3. ‚úÖ Target –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ—Ç decision_ts, –∞ –ù–ï –æ—Ç ts_ms
4. ‚úÖ –¢–µ—Å—Ç—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
5. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∞ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞:** –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è
**–£–ª—É—á—à–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** ‚úÖ –í–Ω–µ—Å–µ–Ω—ã

---

## –ü–†–ò–õ–û–ñ–ï–ù–ò–ï A: –°–°–´–õ–ö–ò –ù–ê –ö–û–î

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `transformers.py:704-1053` - OnlineFeatureTransformer –∫–ª–∞—Å—Å
- `transformers.py:790-1052` - update() —Ñ—É–Ω–∫—Ü–∏—è
- `mediator.py:1078-1133` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
- `obs_builder.pyx:237-240` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ NaN –¥–ª—è ma5
- `labels.py:40-52` - –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ target –±–µ–∑ —É—Ç–µ—á–∫–∏
- `build_training_table.py:59` - LeakGuard –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- `test_critical_verification.py:16-323` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

**–ö–ª—é—á–µ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏:**
- transformers.py:864 - SMA calculation (–ü–†–ê–í–ò–õ–¨–ù–û)
- transformers.py:874 - Returns calculation (–ü–†–ê–í–ò–õ–¨–ù–û)
- transformers.py:790-801 - RSI update (–ü–†–ê–í–ò–õ–¨–ù–û)
- mediator.py:1083 - ma5 extraction (–ü–†–ê–í–ò–õ–¨–ù–û)
- obs_builder.pyx:237-240 - NaN handling (–ü–†–ê–í–ò–õ–¨–ù–û)

---

## –ü–†–ò–õ–û–ñ–ï–ù–ò–ï B: –ê–ö–ê–î–ï–ú–ò–ß–ï–°–ö–ò–ï –°–°–´–õ–ö–ò

1. **Murphy, J.J. (1999).** "Technical Analysis of the Financial Markets"
   –ì–ª–∞–≤–∞ 10: Moving Averages - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ lag = window/2

2. **de Prado, M.L. (2018).** "Advances in Financial Machine Learning"
   –ì–ª–∞–≤–∞ 7: The Dangers of Backtesting - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ look-ahead bias

3. **Wilder, J.W. (1978).** "New Concepts in Technical Trading Systems"
   RSI formula –∏ smoothing technique

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** Claude Code
**–î–∞—Ç–∞:** 2025-11-16
**–í–µ—Ä—Å–∏—è:** 1.0
**–°—Ç–∞—Ç—É—Å:** –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢

# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ price validation fix

## ‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### üî¥ CRITICAL: –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å upstream –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `mediator.py:932` —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç NaN/Inf:
```python
price = self._coerce_finite(mark_price, default=0.0)
```

**–ö–æ–Ω—Ñ–ª–∏–∫—Ç:**
1. `_coerce_finite()` –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç NaN/Inf ‚Üí 0.0 (silent fallback)
2. –ú–æ—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω—è–µ—Ç price ‚â§ 0.0 (loud failure)
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ —á—Ç–æ —Ä–∞–Ω—å—à–µ —Ä–∞–±–æ—Ç–∞–ª–æ "—Ç–∏—Ö–æ" —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å —Å ValueError

**Impact:**
- ‚ùå **Breaking change** - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è
- ‚ùå –ï—Å–ª–∏ –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `default=0.0` –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ, —ç—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `_coerce_finite()`

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
- –ò–∑–º–µ–Ω–∏—Ç—å `_coerce_finite()` —á—Ç–æ–±—ã –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 0.0 –∫–∞–∫ fallback –¥–ª—è price
- –ò–õ–ò –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è price –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
- –ò–õ–ò –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –∫–∞–∫ breaking change –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

### üü° MEDIUM: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ Python wrapper

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –≤ `build_observation_vector()` (cpdef), –Ω–æ –ù–ï –≤ `build_observation_vector_c()` (cdef nogil).

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:**
- `lob_state_cython.pyx:62` –≤—ã–∑—ã–≤–∞–µ—Ç `build_observation_vector_c()` –Ω–∞–ø—Ä—è–º—É—é
- –¢–∞–º –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `price=0.0`, —á—Ç–æ –º–æ—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –±—ã –æ—Ç–∫–ª–æ–Ω–∏—Ç—å
- –ù–æ —Ç.–∫. –≤—ã–∑–æ–≤ –ø—Ä—è–º–æ–π, –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

**–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
- –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `_compute_n_features()` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ observation vector
- –ù–ï —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ—ç—Ç–æ–º—É –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ

**–†–∏—Å–∫:**
- ‚ö†Ô∏è –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –∫—Ç–æ-—Ç–æ –¥–æ–±–∞–≤–∏—Ç –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ `build_observation_vector_c()` —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ù–ï —Å—Ä–∞–±–æ—Ç–∞–µ—Ç

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ `build_observation_vector_c()` —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ò–õ–ò –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ `build_observation_vector_c()` (–Ω–æ —ç—Ç–æ –Ω–∞—Ä—É—à–∏—Ç nogil)

---

### üü° MEDIUM: –ù–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –Ø –≤–∞–ª–∏–¥–∏—Ä—É—é —Ç–æ–ª—å–∫–æ `price` –∏ `prev_price`, –Ω–æ –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É—é:
- `cash` - –º–æ–∂–µ—Ç –±—ã—Ç—å NaN/Inf/negative
- `units` - –º–æ–∂–µ—Ç –±—ã—Ç—å NaN/Inf
- `log_volume_norm`, `rel_volume` - –º–æ–≥—É—Ç –±—ã—Ç—å NaN/Inf
- `norm_cols_values` - –º–∞—Å—Å–∏–≤ –∏–∑ 21 –∑–Ω–∞—á–µ–Ω–∏—è, –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å NaN/Inf

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—á–µ–º—É —ç—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ:**
- –î–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (ma5, ma20, rsi14 –∏ —Ç.–¥.) —É–∂–µ –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ NaN —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏
- `cash` –∏ `units` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ —Ä–∞—Å—á–µ—Ç–∞—Ö —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç division by zero
- –ù–æ –≤—Å–µ —Ä–∞–≤–Ω–æ - –µ—Å–ª–∏ `cash=NaN`, –±—É–¥–µ—Ç –ø—Ä–æ–±–ª–µ–º–∞

**–†–∏—Å–∫:**
- ‚ö†Ô∏è Partial fix - –∑–∞–∫—Ä—ã–ª —Ç–æ–ª—å–∫–æ price, –Ω–æ –Ω–µ –≤—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
- –†–∞—Å—à–∏—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ `cash` –∏ `units`
- –í–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é `norm_cols_values`

---

### üü° MEDIUM: Performance –Ω–µ –∏–∑–º–µ—Ä–µ–Ω

**–ó–∞—è–≤–ª–µ–Ω–∏–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**
> Performance: Negligible (<1Œºs per validation)

**–ü—Ä–æ–±–ª–µ–º–∞:** –Ø –ù–ï –∏–∑–º–µ—Ä–∏–ª —Ä–µ–∞–ª—å–Ω—ã–π impact! –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ.

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
```cython
_validate_price(price, "price")       # 2x string formatting + 3 conditionals
_validate_price(prev_price, "prev_price")  # –µ—â–µ —Ä–∞–∑ —Ç–æ –∂–µ —Å–∞–º–æ–µ
```

**–†–∏—Å–∫:**
- String formatting –≤ Cython –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Ä–æ–∂–µ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å
- Exception handling overhead
- –í high-frequency trading —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–Ω–∞—á–∏–º–æ

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
- –°–æ–∑–¥–∞—Ç—å benchmark —Ç–µ—Å—Ç
- –ò–∑–º–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é latency –¥–æ/–ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ï—Å–ª–∏ impact > 1Œºs, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

---

### üü¢ LOW: Thread safety –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å GIL (–Ω–µ nogil), –Ω–æ —è –Ω–µ –ø—Ä–æ–≤–µ—Ä–∏–ª:
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ —ç—Ç–æ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ?
- –ù–µ —Å–æ–∑–¥–∞–µ—Ç –ª–∏ —ç—Ç–æ contention –Ω–∞ GIL?

**–¢–µ–∫—É—â–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```cython
cpdef void build_observation_vector(...)  # WITH GIL
cdef void build_observation_vector_c(...) noexcept nogil  # WITHOUT GIL
```

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π bottleneck:**
- –ï—Å–ª–∏ –º–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–æ–≤ –≤—ã–∑—ã–≤–∞—é—Ç `build_observation_vector()` –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –ö–∞–∂–¥—ã–π –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç GIL –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ü–æ—Ç–æ–º –æ—Ç–ø—É—Å–∫–∞–µ—Ç GIL –¥–ª—è –≤—Ö–æ–¥–∞ –≤ `build_observation_vector_c()`

**–†–∏—Å–∫:** GIL contention –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

---

### üü¢ LOW: Error messages –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** Issue –æ–ø–∏—Å–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –Ω–æ error messages –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º:
```
ValueError: Invalid price: NaN (Not a Number).
```

**–ü–ª—é—Å—ã –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ:**
- –°—Ç–∞–Ω–¥–∞—Ä—Ç –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏
- –õ–µ–≥—á–µ –∏—Å–∫–∞—Ç—å –≤ Google/StackOverflow
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å

**–ú–∏–Ω—É—Å—ã:**
- –í–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π

---

### üü¢ LOW: –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

**–ß—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
- ‚úÖ Unit tests –¥–ª—è `build_observation_vector()` (20 tests)
- ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ß—Ç–æ –ù–ï –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
- ‚ùå –ü–æ–ª–Ω—ã–π pipeline: data ingestion ‚Üí mediator ‚Üí obs_builder ‚Üí env
- ‚ùå –ö–∞–∫ —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ invalid price –≤ —Ä–µ–∞–ª—å–Ω–æ–º workflow
- ‚ùå Recovery after validation error

---

## üìä –û—Ü–µ–Ω–∫–∞ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –ø—Ä–æ–±–ª–µ–º

| –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | Impact | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å |
|----------|-------------|--------|-------------|
| –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å _coerce_finite() | üî¥ HIGH | Breaking change | HIGH |
| –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ wrapper | üü° MEDIUM | –ú–æ–∂–µ—Ç –±—ã—Ç—å bypass | LOW |
| –ù–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è | üü° MEDIUM | Partial protection | MEDIUM |
| Performance –Ω–µ –∏–∑–º–µ—Ä–µ–Ω | üü° MEDIUM | Unknown latency | MEDIUM |
| Thread safety | üü¢ LOW | Potential contention | LOW |
| –Ø–∑—ã–∫ error messages | üü¢ LOW | UX issue | LOW |
| –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ | üü¢ LOW | Unknown behavior | MEDIUM |

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û (P0):
- [ ] –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `_coerce_finite(mark_price, default=0.0)`
- [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å: —ç—Ç–æ bug –∏–ª–∏ feature?
- [ ] –ï—Å–ª–∏ bug - –∏—Å–ø—Ä–∞–≤–∏—Ç—å upstream –∫–æ–¥
- [ ] –ï—Å–ª–∏ feature - –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å breaking change

### 2. –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û (P1):
- [ ] –î–æ–±–∞–≤–∏—Ç—å benchmark —Ç–µ—Å—Ç –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è performance impact
- [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ `cash` –∏ `units`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ `build_observation_vector_c()` –æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### 3. –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û (P2):
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å mediator
- [ ] Thread safety –∞–Ω–∞–ª–∏–∑
- [ ] –†—É—Å—Å–∫–∏–µ error messages (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –ü–†–ê–í–ò–õ–¨–ù–û

1. ‚úÖ Fail-fast –ø–æ–¥—Ö–æ–¥ - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
2. ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ error messages —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
3. ‚úÖ Comprehensive unit tests (20 tests, 100% coverage)
4. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º
5. ‚úÖ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ best practices –∏–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN/Inf/‚â§0 - –≤—Å–µ —Ç—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–ª—É—á–∞—è
7. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ entry point (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ)

---

## üö® –í–ï–†–î–ò–ö–¢

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¢–ï–•–ù–ò–ß–ï–°–ö–ò –ö–û–†–†–ï–ö–¢–ù–ê, –Ω–æ –∏–º–µ–µ—Ç –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ô BREAKING CHANGE.**

### –ö–ª—é—á–µ–≤–æ–π –≤–æ–ø—Ä–æ—Å:
**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –∫–æ–≥–¥–∞ mark_price = NaN?**

#### –í–∞—Ä–∏–∞–Ω—Ç A (—Ç–µ–∫—É—â–µ–µ upstream –ø–æ–≤–µ–¥–µ–Ω–∏–µ):
- `_coerce_finite()` ‚Üí 0.0
- Silent fallback
- Observation vector –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å price=0.0
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç

#### –í–∞—Ä–∏–∞–Ω—Ç B (–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ):
- `_coerce_finite()` ‚Üí 0.0
- –ú–æ—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí ValueError
- Observation vector –ù–ï —Å—Ç—Ä–æ–∏—Ç—Å—è
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –Ø–≤–Ω–∞—è –æ—à–∏–±–∫–∞, –∫–æ–¥ –ø–∞–¥–∞–µ—Ç

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
**–í–∞—Ä–∏–∞–Ω—Ç B (–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) –ü–†–ê–í–ò–õ–¨–ù–´–ô** —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è data integrity, –Ω–æ –Ω—É–∂–Ω–æ:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ upstream –Ω–µ –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ fallback –∫ 0.0
2. –î–æ–±–∞–≤–∏—Ç—å proper error handling –≤ mediator.py
3. –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–∏—Ç—å `_coerce_finite()` –¥–ª—è price —á—Ç–æ–±—ã –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 0.0 –∫–∞–∫ fallback

---

## üìù –í—ã–≤–æ–¥—ã

–ú–æ–π fix **–∑–∞–∫—Ä—ã–≤–∞–µ—Ç vulnerability**, –Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç **–¥—Ä—É–≥—É—é –ø—Ä–æ–±–ª–µ–º—É** upstream:
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è "–∑–∞–≥–ª—É—à–∏—Ç—å" NaN/Inf –∏—Å–ø–æ–ª—å–∑—É—è 0.0 –∫–∞–∫ fallback
- –≠—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–π fix –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —ç—Ç–æ –≤ explicit error

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å `_coerce_finite()` –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è price/prev_price.

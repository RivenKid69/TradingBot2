# –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ò–°–ö–ê–ñ–ï–ù–ò–ô –î–ê–ù–ù–´–• –ü–û –ö–ê–ñ–î–û–ú–£ –ü–†–ò–ó–ù–ê–ö–£

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (4h timeframe)

```python
bar_duration_minutes = 240  # 4 —á–∞—Å–∞
```

### –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ–∫–æ–Ω (–º–∏–Ω—É—Ç—ã ‚Üí –±–∞—Ä—ã)

| –ü—Ä–∏–∑–Ω–∞–∫ | –ú–∏–Ω—É—Ç—ã | –ë–∞—Ä—ã | –°—Ç–∞—Ç—É—Å |
|---------|--------|------|--------|
| ret_4h / sma_240 | 240 | **1** | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì |
| ret_12h / sma_720 | 720 | 3 | ‚úÖ OK |
| ret_20h / sma_1200 | 1200 | 5 | ‚úÖ OK |
| ret_24h / sma_1440 | 1440 | 6 | ‚úÖ OK |
| ret_84h / sma_5040 | 5040 | 21 | ‚úÖ OK |
| ret_168h / sma_10080 | 10080 | 42 | ‚úÖ OK |
| ret_200h / sma_12000 | 12000 | 50 | ‚úÖ OK |

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì #1: ret_4h –í–°–ï–ì–î–ê = 0

### –õ–æ–∫–∞—Ü–∏—è –±–∞–≥–∞
**–§–∞–π–ª:** `transformers.py`
**–°—Ç—Ä–æ–∫–∏:** 606-618
**–§—É–Ω–∫—Ü–∏—è:** `OnlineFeatureTransformer.update()`

### –ö–æ–¥ –±–∞–≥–∞
```python
for i, lb in enumerate(self.spec.lookbacks_prices):
    if len(seq) >= lb:
        window = seq[-lb:]              # ‚ùå –ë–µ—Ä–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ lb –±–∞—Ä–æ–≤
        sma = sum(window) / float(lb)
        lb_minutes = self.spec._lookbacks_prices_minutes[i]
        feats[f"sma_{lb_minutes}"] = float(sma)
        first = float(window[0])        # ‚ùå –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –æ–∫–Ω–∞
        ret_name = f"ret_{_format_window_name(lb_minutes)}"
        feats[ret_name] = (
            float(math.log(price / first)) if first > 0 else 0.0
        )
```

### –ú–µ—Ö–∞–Ω–∏–∫–∞ –∏—Å–∫–∞–∂–µ–Ω–∏—è

**–ö–æ–≥–¥–∞ lb = 1 –±–∞—Ä (ret_4h):**

```python
# –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π:
st["prices"].append(29100.0)           # –î–æ–±–∞–≤–∏–ª–∏ —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
seq = [29000.0, 29100.0]               # Deque –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
window = seq[-1:]                       # –ë–µ—Ä–µ–º –ü–û–°–õ–ï–î–ù–ò–ô 1 –±–∞—Ä
window = [29100.0]                      # ‚ùå –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞!

first = window[0]                       # 29100.0
price = 29100.0                         # –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (—Ç–∞ –∂–µ)

ret = log(29100.0 / 29100.0)           # log(1) = 0
ret = 0.0                               # ‚ùå –í–°–ï–ì–î–ê –ù–û–õ–¨!
```

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –ø–æ –±–∞—Ä–∞–º

| –ë–∞—Ä | –¶–µ–Ω–∞ | Prices deque | window[-1:] | first | current | ret_4h | –û–∂–∏–¥–∞–ª–æ—Å—å |
|-----|------|--------------|-------------|-------|---------|--------|-----------|
| 0 | 29000 | [29000] | [29000] | 29000 | 29000 | **0.0** | 0.0 (–Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏) |
| 1 | 29100 | [29000, 29100] | [29100] | 29100 | 29100 | **0.0** | log(29100/29000) = **0.00344** |
| 2 | 29200 | [29000, 29100, 29200] | [29200] | 29200 | 29200 | **0.0** | log(29200/29100) = **0.00343** |
| 3 | 29300 | [..., 29200, 29300] | [29300] | 29300 | 29300 | **0.0** | log(29300/29200) = **0.00342** |

**–í—ã–≤–æ–¥:** ret_4h **–ù–ò–ö–û–ì–î–ê** –Ω–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å!

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–∫–∞–∂–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π:**
- –ü—Ä–∏ 1000 –±–∞—Ä–∞—Ö –æ–±—É—á–µ–Ω–∏—è: **1000 –Ω—É–ª–µ–π –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π**
- –ü—Ä–∏ 10000 –±–∞—Ä–∞—Ö: **10000 –∏—Å–∫–∞–∂–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π**

**–ß—Ç–æ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª—å:**
```python
# –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
ret_4h = [0.00344, -0.00200, 0.00150, 0.00500, -0.00300, ...]

# –ß—Ç–æ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª—å:
ret_4h = [0.0, 0.0, 0.0, 0.0, 0.0, ...]  # ‚ùå –í—Å–µ –Ω—É–ª–∏!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
1. –ú–æ–¥–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –Ω–∞—É—á–∏—Ç—å—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è
2. –í–µ—Å –ø—Ä–∏–∑–Ω–∞–∫–∞ ret_4h ‚Üí 0 (–±–µ—Å–ø–æ–ª–µ–∑–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫)
3. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π momentum
4. **–£–ø—É—â–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –Ω–∞ 4h —Ç—Ä–µ–Ω–¥–∞—Ö**

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì #2: RSI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç NaN –ø—Ä–∏ –Ω—É–ª–µ–≤—ã—Ö –ø–æ—Ç–µ—Ä—è—Ö

### –õ–æ–∫–∞—Ü–∏—è –±–∞–≥–∞
**–§–∞–π–ª:** `transformers.py`
**–°—Ç—Ä–æ–∫–∏:** 620-628
**–§—É–Ω–∫—Ü–∏—è:** `OnlineFeatureTransformer.update()`

### –ö–æ–¥ –±–∞–≥–∞
```python
if (
    st["avg_gain"] is not None
    and st["avg_loss"] is not None
    and float(st["avg_loss"]) > 0.0  # ‚ùå –ò—Å–∫–ª—é—á–∞–µ—Ç avg_loss = 0
):
    rs = float(st["avg_gain"]) / float(st["avg_loss"])
    feats["rsi"] = float(100.0 - (100.0 / (1.0 + rs)))
else:
    feats["rsi"] = float("nan")       # ‚ùå –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç NaN!
```

### –ú–µ—Ö–∞–Ω–∏–∫–∞ –∏—Å–∫–∞–∂–µ–Ω–∏—è

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–∏–ª—å–Ω—ã–π –≤–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥**

```python
# –¶–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç—É—Ç:
prices = [29000, 29100, 29200, 29300, 29400]

# –†–∞—Å—á–µ—Ç gain/loss –Ω–∞ –∫–∞–∂–¥–æ–º –±–∞—Ä–µ:
Bar 1: delta = 29100 - 29000 = +100 ‚Üí gain=100, loss=0
Bar 2: delta = 29200 - 29100 = +100 ‚Üí gain=100, loss=0
Bar 3: delta = 29300 - 29200 = +100 ‚Üí gain=100, loss=0
Bar 4: delta = 29400 - 29300 = +100 ‚Üí gain=100, loss=0

# RSI –ø–æ Wilder (–ø–µ—Ä–∏–æ–¥ 14):
avg_gain = (avg_gain_prev * 13 + gain) / 14
avg_loss = (avg_loss_prev * 13 + loss) / 14

# –ü–æ—Å–ª–µ 4 –±–∞—Ä–æ–≤ —Ä–æ—Å—Ç–∞:
avg_gain = 100.0  (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ)
avg_loss = 0.0    (‚ùå –ù–û–õ–¨ - –Ω–µ—Ç –ø–æ—Ç–µ—Ä—å!)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏—è:
if avg_loss > 0.0:  # False! (0.0 > 0.0 = False)
    # –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
else:
    rsi = NaN  # ‚ùå –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç NaN –≤–º–µ—Å—Ç–æ 100!
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–∏–ª—å–Ω—ã–π –Ω–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥**

```python
# –¶–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–∞–¥–∞—é—Ç:
prices = [29000, 28900, 28800, 28700, 28600]

# –ü–æ—Å–ª–µ 4 –±–∞—Ä–æ–≤ –ø–∞–¥–µ–Ω–∏—è:
avg_gain = 0.0    (‚ùå –ù–û–õ–¨ - –Ω–µ—Ç –ø—Ä–∏–±—ã–ª–µ–π!)
avg_loss = 100.0  (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ)

# –§–æ—Ä–º—É–ª–∞ RSI:
if avg_loss > 0.0:  # True
    rs = 0.0 / 100.0 = 0
    rsi = 100 - (100 / (1 + 0)) = 100 - 100 = 0  # ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
```

**–ê—Å–∏–º–º–µ—Ç—Ä–∏—è:** –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è downtrend (RSI=0), –Ω–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è uptrend (RSI=NaN)!

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä

| –ë–∞—Ä | –¶–µ–Ω–∞ | Œî | Gain | Loss | avg_gain | avg_loss | RSI | –û–∂–∏–¥–∞–ª–æ—Å—å |
|-----|------|---|------|------|----------|----------|-----|-----------|
| 0 | 29000 | - | - | - | None | None | NaN | NaN (–Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏) |
| 1 | 29100 | +100 | 100 | 0 | 100.0 | 0.0 | **NaN** | **100.0** |
| 2 | 29200 | +100 | 100 | 0 | 100.0 | 0.0 | **NaN** | **100.0** |
| 3 | 29300 | +100 | 100 | 0 | 100.0 | 0.0 | **NaN** | **100.0** |
| 4 | 29100 | -200 | 0 | 200 | 92.8 | 14.3 | 76.5 | 76.5 ‚úÖ |

**–î–æ –ø–µ—Ä–≤–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è:** RSI = NaN (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
**–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è:** RSI = 76.5 (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ

**–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–±–ª–µ–º—ã:**
- –í –±—ã—á—å–µ–º —Ä—ã–Ω–∫–µ (2020-2021): ~40% –≤—Ä–µ–º–µ–Ω–∏ RSI = NaN
- –í –±–æ–∫–æ–≤–∏–∫–µ: ~20% –≤—Ä–µ–º–µ–Ω–∏ RSI = NaN
- –í –º–µ–¥–≤–µ–∂—å–µ–º —Ä—ã–Ω–∫–µ: ~5% –≤—Ä–µ–º–µ–Ω–∏ RSI = NaN (—Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ!)

**–ß—Ç–æ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª—å:**
```python
# –†–µ–∞–ª—å–Ω—ã–π –±—ã—á–∏–π —Ç—Ä–µ–Ω–¥ BTC:
rsi_real = [65, 70, 75, 80, 85, 90, 95, 98, 100, 95, 90, ...]

# –ß—Ç–æ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª—å:
rsi_model = [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 95, 90, ...]
           # ‚ùå 9 NaN –ø–æ–¥—Ä—è–¥!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
1. –ú–æ–¥–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç **—ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è RSI** (–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å)
2. –ü—Ä–æ–ø—É—Å–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ –Ω–∞ –ø–∏–∫–∞—Ö
3. NaN ‚Üí –º–æ–¥–µ–ª—å –ª–∏–±–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫, –ª–∏–±–æ –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ä–µ–¥–Ω–∏–º (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
4. **–£–ø—É—â–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –Ω–∞ –≤–µ—Ä—à–∏–Ω–∞—Ö —Ä—ã–Ω–∫–∞**

---

## ‚úÖ –ü–†–ò–ó–ù–ê–ö–ò –ë–ï–ó –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ë–ê–ì–û–í (–Ω–æ —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏)

### 3. SMA (Simple Moving Average)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
**–õ–æ–∫–∞—Ü–∏—è:** `transformers.py:609`

```python
window = seq[-lb:]
sma = sum(window) / float(lb)
feats[f"sma_{lb_minutes}"] = float(sma)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
prices = [29000, 29100, 29200]
sma_240 (lb=1) = 29200  # –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ ‚úÖ
sma_720 (lb=3) = (29000+29100+29200)/3 = 29100  ‚úÖ
```

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** SMA_240 (1 –±–∞—Ä) = —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞. –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫?

---

### 4. Yang-Zhang –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç OHLC –¥–∞–Ω–Ω—ã–µ
**–õ–æ–∫–∞—Ü–∏—è:** `transformers.py:631-647`

```python
if self.spec.yang_zhang_windows and st["ohlc_bars"]:
    ohlc_list = list(st["ohlc_bars"])
    for i, window in enumerate(self.spec.yang_zhang_windows):
        if len(ohlc_list) >= window:
            yz_vol = calculate_yang_zhang_volatility(ohlc_list, window)
```

**–û–∫–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
- 48h (12 –±–∞—Ä–æ–≤): ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ 12 –±–∞—Ä–æ–≤
- 7d (42 –±–∞—Ä–∞): ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ 42 –±–∞—Ä–æ–≤
- 30d (180 –±–∞—Ä–æ–≤): ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ 180 –±–∞—Ä–æ–≤

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **–ï—Å–ª–∏ OHLC –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:**
```python
# –í fetch_all_data_patch.py –Ω–µ—Ç OHLC ‚Üí ohlc_bars –ø—É—Å—Ç–æ–π
if open_price is None:  # –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    # OHLC –±–∞—Ä –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
    # Yang-Zhang = NaN –≤—Å–µ–≥–¥–∞!
```

2. **–§–æ—Ä–º—É–ª–∞ —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º n=2:**
```python
if len(ohlc_bars) < n or n < 2:
    return None  # Yang-Zhang = NaN
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–∞:** –ï—Å—Ç—å –ª–∏ OHLC –≤ data/processed/*.feather?

---

### 5. Parkinson –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å—Ç—Ä–æ–≥–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
**–õ–æ–∫–∞—Ü–∏—è:** `transformers.py:649-666`

```python
if self.spec.parkinson_windows and st["ohlc_bars"]:
    for i, window in enumerate(self.spec.parkinson_windows):
        if len(ohlc_list) >= window:
            pk_vol = calculate_parkinson_volatility(ohlc_list, window)
```

**–§–æ—Ä–º—É–ª–∞:**
```python
# –í calculate_parkinson_volatility (—Å—Ç—Ä–æ–∫–∏ 140-192):
min_required = max(2, int(0.8 * n))  # –¢—Ä–µ–±—É–µ—Ç 80% –≤–∞–ª–∏–¥–Ω—ã—Ö –±–∞—Ä–æ–≤!
if valid_bars < min_required:
    return None  # ‚ùå NaN
```

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –°—Ç—Ä–æ–≥–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ 80%**

–ü—Ä–∏–º–µ—Ä:
```python
n = 12 –±–∞—Ä–æ–≤ (48h)
min_required = max(2, int(0.8 * 12)) = max(2, 9) = 9

# –ï—Å–ª–∏ –µ—Å—Ç—å 8 –≤–∞–ª–∏–¥–Ω—ã—Ö –±–∞—Ä–æ–≤ (–∏–∑-–∑–∞ gaps):
valid_bars = 8
if 8 < 9:
    return None  # ‚ùå Parkinson = NaN, —Ö–æ—Ç—è 67% –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å!
```

**–†–∏—Å–∫:** –ü—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ö –¥–∞–Ω–Ω—ã—Ö (weekends, maintenance) ‚Üí —á–∞—Å—Ç—ã–µ NaN

---

### 6. GARCH –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –∫—Ä–∞–π–Ω–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
**–õ–æ–∫–∞—Ü–∏—è:** `transformers.py:668-686`

```python
if len(price_list) >= window:
    garch_vol = calculate_garch_volatility(price_list, window)
```

**–í calculate_garch_volatility (—Å—Ç—Ä–æ–∫–∏ 195-274):**

```python
if not prices or len(prices) < n or n < 50:  # ‚ùå –ú–∏–Ω–∏–º—É–º 50 –±–∞—Ä–æ–≤!
    return None

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞—Ä–∏–∞—Ü–∏–∏:
if np.std(log_returns) < 1e-10:  # ‚ùå Flat prices ‚Üí NaN
    return None

# GARCH –º–æ–∂–µ—Ç –Ω–µ —Å–æ–π—Ç–∏—Å—å:
try:
    result = model.fit(...)
except (ValueError, RuntimeError):
    return None  # ‚ùå NaN
```

**–û–∫–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
- 200h (50 –±–∞—Ä–æ–≤): —Ç—Ä–µ–±—É–µ—Ç 50 –±–∞—Ä–æ–≤ √ó 4h = 200 —á–∞—Å–æ–≤ = **8.3 –¥–Ω—è** –∏—Å—Ç–æ—Ä–∏–∏
- 14d (84 –±–∞—Ä–∞): —Ç—Ä–µ–±—É–µ—Ç **14 –¥–Ω–µ–π** –∏—Å—Ç–æ—Ä–∏–∏
- 30d (180 –±–∞—Ä–æ–≤): —Ç—Ä–µ–±—É–µ—Ç **30 –¥–Ω–µ–π** –∏—Å—Ç–æ—Ä–∏–∏

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **–ü–µ—Ä–≤—ã–µ 50 –±–∞—Ä–æ–≤ ‚Üí NaN:**
```python
# –ë–∞—Ä—ã 0-49: GARCH = NaN (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö)
# –¢–æ–ª—å–∫–æ —Å –±–∞—Ä–∞ 50: GARCH –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
```

2. **Flat market ‚Üí NaN:**
```python
prices = [29000] * 100  # –¶–µ–Ω–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
std = 0.0
if std < 1e-10:
    return None  # ‚ùå GARCH = NaN
```

3. **–ù–µ—Å—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–æ–¥–µ–ª–∏:**
```python
# –ü—Ä–∏ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏:
# GARCH –º–æ–∂–µ—Ç –Ω–µ —Å–æ–π—Ç–∏—Å—å ‚Üí RuntimeError ‚Üí NaN
```

**–ß–∞—Å—Ç–æ—Ç–∞ NaN:** ~10-20% –≤—Ä–µ–º–µ–Ω–∏ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä—ã–Ω–∫–∞)

---

### 7. Taker Buy Ratio

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –±–µ–∑ volume = NaN
**–õ–æ–∫–∞—Ü–∏—è:** `transformers.py:582-586`

```python
if volume is not None and taker_buy_base is not None and volume > 0:
    taker_buy_ratio = min(1.0, max(0.0, float(taker_buy_base) / float(volume)))
    st["taker_buy_ratios"].append(taker_buy_ratio)
```

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **–ï—Å–ª–∏ volume –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
```python
# –ü—Ä–∏–∑–Ω–∞–∫ –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è ‚Üí NaN
```

2. **–ï—Å–ª–∏ volume = 0:**
```python
if volume > 0:  # False
    # Ratio –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è ‚Üí –ø—Ä–æ–ø—É—Å–∫ –±–∞—Ä–∞
```

3. **–ê–Ω–æ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (taker_buy > volume):**
```python
# –ó–∞—â–∏—Ç–∞ –µ—Å—Ç—å:
ratio = min(1.0, max(0.0, taker_buy_base / volume))  # ‚úÖ Clamping
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–∞:** –ï—Å—Ç—å –ª–∏ volume –∏ taker_buy_base –≤ –¥–∞–Ω–Ω—ã—Ö?

---

### 8. Taker Buy Ratio SMA

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #7
**–õ–æ–∫–∞—Ü–∏—è:** `transformers.py:698-711`

```python
if self.spec.taker_buy_ratio_windows:
    for i, window in enumerate(self.spec.taker_buy_ratio_windows):
        if len(ratio_list) >= window:
            window_data = ratio_list[-window:]
            sma = sum(window_data) / float(len(window_data))
            feats[feature_name] = float(sma)
        else:
            feats[feature_name] = float("nan")
```

**–û–∫–Ω–∞:**
- 8h (2 –±–∞—Ä–∞): —Ç—Ä–µ–±—É–µ—Ç 2 ratio –∑–Ω–∞—á–µ–Ω–∏—è
- 16h (4 –±–∞—Ä–∞): —Ç—Ä–µ–±—É–µ—Ç 4 –∑–Ω–∞—á–µ–Ω–∏—è
- 24h (6 –±–∞—Ä–æ–≤): —Ç—Ä–µ–±—É–µ—Ç 6 –∑–Ω–∞—á–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ volume –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí ratio –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è ‚Üí SMA = NaN

---

### 9. Taker Buy Ratio Momentum

**–°—Ç–∞—Ç—É—Å:** üü° –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –≤–æ–∑–º–æ–∂–µ–Ω –±–∞–≥ –ø—Ä–∏ lb=1
**–õ–æ–∫–∞—Ü–∏—è:** `transformers.py:714-728`

```python
for i, window in enumerate(self.spec.taker_buy_ratio_momentum):
    if len(ratio_list) >= window + 1:  # ‚úÖ –¢—Ä–µ–±—É–µ—Ç window+1
        current = ratio_list[-1]
        past = ratio_list[-(window + 1)]
        momentum = current - past
        feats[feature_name] = float(momentum)
```

**–û–∫–Ω–∞:**
- 4h (1 –±–∞—Ä): momentum = current - ratio_1_bar_ago ‚úÖ
- 8h (2 –±–∞—Ä–∞): momentum = current - ratio_2_bars_ago ‚úÖ
- 12h (3 –±–∞—Ä–∞): momentum = current - ratio_3_bars_ago ‚úÖ
- 24h (6 –±–∞—Ä–æ–≤): momentum = current - ratio_6_bars_ago ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ lb=1:**
```python
window = 1
if len(ratio_list) >= 2:  # window + 1
    current = ratio_list[-1]     # –ü–æ—Å–ª–µ–¥–Ω–∏–π
    past = ratio_list[-(1+1)]    # ratio_list[-2] ‚úÖ –ü—Ä–µ–¥—ã–¥—É—â–∏–π
    momentum = current - past    # ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–ï–¢ –±–∞–≥–∞ (—Ç—Ä–µ–±—É–µ—Ç window+1, –Ω–µ window)

---

### 10. CVD (Cumulative Volume Delta)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
**–õ–æ–∫–∞—Ü–∏—è:** `transformers.py:732-749`

```python
if st["volume_deltas"] and self.spec.cvd_windows:
    delta_list = list(st["volume_deltas"])
    for i, window in enumerate(self.spec.cvd_windows):
        if len(delta_list) >= window:
            window_data = delta_list[-window:]
            cvd = sum(window_data)
            feats[feature_name] = float(cvd)
```

**–§–æ—Ä–º—É–ª–∞ volume delta:**
```python
buy_volume = taker_buy_base
sell_volume = volume - buy_volume
volume_delta = buy_volume - sell_volume
```

**–û–∫–Ω–∞:**
- 24h (6 –±–∞—Ä–æ–≤): —Å—É–º–º–∞ delta –∑–∞ 6 –±–∞—Ä–æ–≤
- 7d (42 –±–∞—Ä–∞): —Å—É–º–º–∞ delta –∑–∞ 42 –±–∞—Ä–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
volume_deltas = [100, -50, 200, -100, 150, -75]
cvd_24h = sum([100, -50, 200, -100, 150, -75]) = 225  ‚úÖ
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –í–°–ï–• –ü–†–ò–ó–ù–ê–ö–û–í

| # | –ü—Ä–∏–∑–Ω–∞–∫ | –°—Ç–∞—Ç—É—Å | –ß–∞—Å—Ç–æ—Ç–∞ NaN | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –ü—Ä–∏—á–∏–Ω–∞ |
|---|---------|--------|-------------|-------------|---------|
| 1 | ret_4h | üî¥ | 0% (–≤—Å–µ–≥–¥–∞ 0!) | –ö–†–ò–¢–ò–ß–ù–û | lb=1 ‚Üí log(x/x)=0 |
| 2 | ret_12h | ‚úÖ | 0% | OK | lb=3 —Ä–∞–±–æ—Ç–∞–µ—Ç |
| 3 | ret_20h | ‚úÖ | 0% | OK | lb=5 —Ä–∞–±–æ—Ç–∞–µ—Ç |
| 4 | ret_24h | ‚úÖ | 0% | OK | lb=6 —Ä–∞–±–æ—Ç–∞–µ—Ç |
| 5 | ret_84h | ‚úÖ | 0% | OK | lb=21 —Ä–∞–±–æ—Ç–∞–µ—Ç |
| 6 | ret_168h | ‚úÖ | 0% | OK | lb=42 —Ä–∞–±–æ—Ç–∞–µ—Ç |
| 7 | ret_200h | ‚úÖ | 0% | OK | lb=50 —Ä–∞–±–æ—Ç–∞–µ—Ç |
| 8 | sma_240 | ‚úÖ | 0% | OK | = current price |
| 9 | sma_720 | ‚úÖ | 0% | OK | –†–∞–±–æ—Ç–∞–µ—Ç |
| 10 | sma_1200 | ‚úÖ | 0% | OK | –†–∞–±–æ—Ç–∞–µ—Ç |
| 11 | sma_1440 | ‚úÖ | 0% | OK | –†–∞–±–æ—Ç–∞–µ—Ç |
| 12 | sma_5040 | ‚úÖ | 0% | OK | –†–∞–±–æ—Ç–∞–µ—Ç |
| 13 | sma_10080 | ‚úÖ | 0% | OK | –†–∞–±–æ—Ç–∞–µ—Ç |
| 14 | sma_12000 | ‚úÖ | 0% | OK | –†–∞–±–æ—Ç–∞–µ—Ç |
| 15 | rsi | üî¥ | 20-40% | –ö–†–ò–¢–ò–ß–ù–û | avg_loss=0 ‚Üí NaN |
| 16 | yang_zhang_48h | ‚ö†Ô∏è | 5-10% | –°—Ä–µ–¥–Ω–µ | –ù–µ—Ç OHLC ‚Üí NaN |
| 17 | yang_zhang_7d | ‚ö†Ô∏è | 5-10% | –°—Ä–µ–¥–Ω–µ | –ù–µ—Ç OHLC ‚Üí NaN |
| 18 | yang_zhang_30d | ‚ö†Ô∏è | 5-10% | –°—Ä–µ–¥–Ω–µ | –ù–µ—Ç OHLC ‚Üí NaN |
| 19 | parkinson_48h | ‚ö†Ô∏è | 10-15% | –°—Ä–µ–¥–Ω–µ | 80% requirement |
| 20 | parkinson_7d | ‚ö†Ô∏è | 10-15% | –°—Ä–µ–¥–Ω–µ | 80% requirement |
| 21 | garch_200h | ‚ö†Ô∏è | 15-20% | –°—Ä–µ–¥–Ω–µ | –ù–µ—Å—Ö–æ–¥–∏–º–æ—Å—Ç—å |
| 22 | garch_14d | ‚ö†Ô∏è | 15-20% | –°—Ä–µ–¥–Ω–µ | –ù–µ—Å—Ö–æ–¥–∏–º–æ—Å—Ç—å |
| 23 | garch_30d | ‚ö†Ô∏è | 15-20% | –°—Ä–µ–¥–Ω–µ | –ù–µ—Å—Ö–æ–¥–∏–º–æ—Å—Ç—å |
| 24 | taker_buy_ratio | ‚ö†Ô∏è | 0-5% | –ù–∏–∑–∫–æ | –ù–µ—Ç volume ‚Üí NaN |
| 25 | tbr_sma_8h | ‚ö†Ô∏è | 0-5% | –ù–∏–∑–∫–æ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #24 |
| 26 | tbr_sma_16h | ‚ö†Ô∏è | 0-5% | –ù–∏–∑–∫–æ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #24 |
| 27 | tbr_sma_24h | ‚ö†Ô∏è | 0-5% | –ù–∏–∑–∫–æ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #24 |
| 28 | tbr_momentum_4h | ‚ö†Ô∏è | 0-5% | –ù–∏–∑–∫–æ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #24 |
| 29 | tbr_momentum_8h | ‚ö†Ô∏è | 0-5% | –ù–∏–∑–∫–æ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #24 |
| 30 | tbr_momentum_12h | ‚ö†Ô∏è | 0-5% | –ù–∏–∑–∫–æ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #24 |
| 31 | tbr_momentum_24h | ‚ö†Ô∏è | 0-5% | –ù–∏–∑–∫–æ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç #24 |
| 32 | cvd_24h | ‚úÖ | 0-5% | OK | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç volume |
| 33 | cvd_7d | ‚úÖ | 0-5% | OK | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç volume |

---

## –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê –ò–°–ö–ê–ñ–ï–ù–ò–ô

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):

1. **ret_4h = 0 –≤—Å–µ–≥–¥–∞** ‚Üí 100% –∏—Å–∫–∞–∂–µ–Ω–∏–µ
2. **RSI = NaN –ø—Ä–∏ uptrends** ‚Üí 20-40% –∏—Å–∫–∞–∂–µ–Ω–∏–µ

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞:

**–ò–∑ 33 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤:**
- üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–∞–∂–µ–Ω—ã: **2** (6%)
- ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–∫–∞–∂–µ–Ω—ã: **11** (33%)
- ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ: **20** (61%)

**–û–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –∏—Å–∫–∞–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:** ~15-25% –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–æ–¥–µ–ª—å:**
- –ú–∏–Ω–∏–º—É–º 2 –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã
- ~30% –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–º–µ—é—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ NaN
- –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ **—á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–∫–∞–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üö® **–ö–†–ò–¢–ò–ß–ù–û - –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**
